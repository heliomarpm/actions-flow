name: CD - Semantic Release

on:
  workflow_call:
    inputs:
      stack:
        description: 'Stack the project. (node | php | dotnet | python | go | empty for auto-detect)'
        required: false
        type: string
        default: null
      project_path:
        description: 'Project path source code'
        required: false
        type: string
        default: null

      custom_config:
        description: 'Path to semantic-release config file.'
        required: false
        type: string
      branches:
        description: |
          'The branches on which releases should happen. It will override the branches attribute in your configuration file.'
          'Support for semantic-release above v16.'
          'See https://semantic-release.gitbook.io/semantic-release/usage/configuration#branches for more information.' 
        required: false
        default: [ "main", { "name": "release", "prerelease": true }, { "name": "develop", "prerelease": true } ]
      extra_plugins:
        description: 'Extra plugins for pre-install. You can also specify specifying version range for the extra plugins if you prefer.'
        required: false
        default: |
          ["@semantic-release/changelog", { "changelogFile": "CHANGELOG.md" }], 
          ["@semantic-release/npm", { "npmPublish": false, "failComment": true }], 
          ["@semantic-release/github", { "successComment": false }], 
          [ "@semantic-release/git", { 
            "assets": ["CHANGELOG.md", "package.json"], 
            "message": "chore(release): ${nextRelease.version} [skip ci]\n\n${nextRelease.notes}" 
          } ]
      dry_run:
        description: 'Dry run mode for semantic-release. (default: false -> true for PRs)'
        required: false
        type: boolean
        default: false
      debug_mode:
        description: 'Debug mode for semantic-release.'
        required: false
        type: boolean
        default: false
      strict_conventional_commits:
        description: 'Fail pipeline if no conventional commits are found'
        required: false
        type: boolean
        default: true

    secrets:
      GH_TOKEN:
        required: true

jobs:
  semantic-release:
    runs-on: ubuntu-latest
    env:
      REUSABLE_PATH: ${{ github.workspace }}/__reusable_flow__
      BASH_ENV: ${{ github.workspace }}/__reusable_flow__/scripts/shared/shell-helpers.sh

    # defaults:
    #   run:
    #     shell: bash
    #     working-directory: ${{ needs.workdir.outputs.path || '.' }}

    permissions:
      actions: read
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: ðŸ“Œ Checkout consumer repository
        uses: actions/checkout@v4
        with:
          # A linha 'ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0 # NecessÃ¡rio para o semantic-release inspecionar histÃ³rico
          fetch-tags: true # NecessÃ¡rio para o semantic-release inspecionar tags
          persist-credentials: true # â†’ permite push com GITHUB_TOKEN
          token: ${{ secrets.GH_TOKEN }} # NecessÃ¡rio para autenticar PUSH

      - name: ðŸ“Œ Checkout reusable repository
        uses: actions/checkout@v4
        with:
          repository: heliomarpm/actions-flow
          ref: main # ${{ github.ref }}
          path: ${{ env.REUSABLE_PATH }}

      - name: ðŸ“ Resolve project path
        id: path
        run: |
          PROJECT_PATH="$(resolve_project_path '${{ inputs.project_path }}')"
          log "ðŸ”¹ Using project path: $PROJECT_PATH"
          echo "value=$PROJECT_PATH" >> "$GITHUB_OUTPUT"

      - name: ðŸ‘€ Files in workspace
        run: |
          ls_files

      - name: ðŸ” Resolve project stack
        id: stack
        working-directory: ${{ steps.path.outputs.value }}
        run: |
          STACK="${{ inputs.stack }}"
          if [[ -n "$STACK" && "$STACK" != "auto" ]]; then
            echo "ðŸ”¹ Using stack from input: $STACK"
            echo "value=$STACK" >> $GITHUB_OUTPUT
            echo "source=input" >> $GITHUB_OUTPUT
            exit 0
          fi

          SCRIPT="$REUSABLE_PATH/scripts/shared/detect-stack.sh"
          chmod +x "$SCRIPT"
          STACK=$("$SCRIPT" "${{ steps.path.outputs.value }}")

          echo "value=$STACK" >> $GITHUB_OUTPUT
          echo "source=detected" >> $GITHUB_OUTPUT

      - name: âŒ Fail if stack not detected
        if: steps.stack.outputs.value == ''
        run: fail "Stack not detected. Check project_path or repository structure."

      - name: âš™ï¸ Configurar UsuÃ¡rio Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: ðŸš€ Run Semantic Release
        if: steps.stack.outputs.value != ''
        working-directory: ${{ steps.path.outputs.value }}
        run: |
          SCRIPT="$REUSABLE_PATH/scripts/shared/semantic-release/run.sh"
          chmod +x "$SCRIPT"
          "$SCRIPT"
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          STACK: ${{ steps.stack.outputs.value }}
          REUSABLE_PATH: ${{ env.REUSABLE_PATH }}
          CUSTOM_CONFIG: ${{ inputs.custom_config }}
          DRY_RUN: ${{ inputs.dry_run }}
          DEBUG_MODE: ${{ inputs.debug_mode }}
          STRICT_CONVENTIONAL_COMMITS: ${{ inputs.strict_conventional_commits }}

      - name: ðŸ§¾ Job Summary
        if: always()
        run: |
          {
            echo "## ðŸ“Œ Semantic Release"
            echo ""
            echo "**ðŸ“‚ Project path:** \`${{ inputs.project_path }}\`"
            echo ""

            if [[ "${{ steps.stack.outputs.value }}" != "" ]]; then
              echo "**ðŸ§± Stack:** \`${{ steps.stack.outputs.value }}\` (_${{ steps.stack.outputs.source }}_)"
            else
              echo "**ðŸ§± Stack:** âŒ not detected"
            fi
          } >> $GITHUB_STEP_SUMMARY
